<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" integrity="sha256-aa0xaJgmK/X74WM224KMQeNQC2xYKwlAt08oZqjeF0E=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"  crossorigin="anonymous"/>

</head>

<body>
    <div id='fileupload' class='panel panel-body col-md-12'>
        <input type="file" id='logfile' onchange=openFile(event)>
    </div>
    <div id='container' class='col-md-12'>
        <div id='devices' class='panel panel-body col-md-12'>
            <div class='col-md-6 float-left'>
                <table id='antDevices' class='table-bordered table-striped table'>
                    <thead>
                        <tr>
                            <th>Dispositivos ANT+</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div class='col-md-6 float-right'>
                <table id='bleDevices' class='table-bordered table-striped table'>
                    <thead>
                        <tr>
                            <th>Dispositivos BLE</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class='col-md-12'>
    <canvas id='fpsGraph' width='700' height="250"></canvas>
    </div>
    <!-- Optional JavaScript -->
   
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/moment-duration-format/1.3.0/moment-duration-format.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.2/Chart.min.js"></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.4"></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/chartjs-plugin-draggable@0.1.6/dist/chartjs-plugin-draggable.min.js'></script>
    <!--<script type='text/javascript' src='https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.1.2'></script>-->
    <script type='text/javascript' src="https://cdn.jsdelivr.net/npm/bootstrap-filestyle@1.2.1/src/bootstrap-filestyle.min.js"></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/3.0.0/exceljs.min.js"></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script type='text/javascript' src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
</body>
<script>
    var log, devices, detectedDevices, fpsData;
    var openFile = function (event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function () {
            var text = reader.result;
            log = text
            getDevices().then(function () {
                createDevicesTable()
            })
            getFPS().then(function (data) {
                plotFPS(data)
            })
        };
        reader.readAsText(input.files[0]);
    };

    async function getDevices() {
        var logLines = log.split("\r\n")
        detectedDevices = logLines.filter(line => line.includes("[ANT]") || line.includes("[BLE]"))
        devices = { ant: [], ble: [], used: [] }
        //Buscamos los dispositivos conectados

        detectedDevices.forEach(element => {
            element = element.substring(10).trim()
            if (element.includes(["ANT"]) && !devices.ant.includes(element)) {
                devices.ant.push(element);
            }

            if (element.includes(["BLE"]) && !devices.ble.includes(element)) {
                devices.ble.push(element);
            }
        })
    }

    async function getFPS() {

        var logLines = log.split("\r\n");
        var fpsData = []
        fpsLines = logLines.filter(line => line.includes("FPS"));
        fpsLines.forEach(line => {
            var usefulData = line.split(",")[0]
            var measure_time = usefulData.substring(1, 9);
            var measure_fps = usefulData.split("FPS")[1].trim();
            fpsData.push([measure_time, parseFloat(measure_fps)])
        })

        return fpsData
    }

    function plotFPS(data) {
        //$("#devices").after(`<div id='fpsGraph' class='panel panel-body col-md-6'></div>`)
        const fpsTime = data.map(function (item) {
            return item[0];
        });
        const fpsVal = data.map(function (item) {
            return item[1];
        });
        var fpschartDom = document.getElementById("fpsGraph").getContext('2d')
        var option;
        option = {
            type:'line',
            data:fpsVal
        };

        const fpsChart = new Chart(fpschartDom, option)
        fpsChart.render()

    }

    function createDevicesTable() {
        $("#antDevices tbody, #bleDevices tbody").empty()
        devices.ant.forEach(device => $("#antDevices tbody").append(`<tr><td>${device}</td></tr>`))
        devices.ble.forEach(device => $("#bleDevices tbody").append(`<tr><td>${device}</td></tr>`))
    }
</script>

</html>
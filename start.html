<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel='stylesheer' href='styles.css'>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.2.2/echarts.min.js"
        integrity="sha512-ivdGNkeO+FTZH5ZoVC4gS4ovGSiWc+6v60/hvHkccaMN2BXchfKdvEZtviy5L4xSpF8NPsfS0EVNSGf+EsUdxA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.2.2/echarts.common.min.js"
        integrity="sha512-yW/fyb+c/Wvp5o1p7L20p3WbZI+ziiSj2Is9tJfqUtEE7099oXxVHFaa92oHLgXiJXCYMeFDKPTseP2PMaHckA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.2.2/i18n/langES-obj.min.js"
        integrity="sha512-uCX5095ZMlfHnnymRsknBVuWmNHX32hSuzcGRYpIoYvXTlTa11A+e1D3K6U+mXTNSP9plMWV5NtTSHBpXGtHJA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

</head>

<body>
    <!--
    <div id='fileupload' class='panel panel-body col-md-12'>
        <input type="file" id='logfile' onchange=openFile(event)>
    </div>
    <div id='container' class='col-md-12'>
        <div id='devices' class='panel panel-body col-md-12'>
            <div class='col-md-6 float-left'>
                <table id='antDevices' class='table-bordered table-striped table'>
                    <thead>
                        <tr>
                            <th>Dispositivos ANT+</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div class='col-md-6 float-right'>
                <table id='antDevices' class='table-bordered table-striped table'>
                    <thead>
                        <tr>
                            <th>Dispositivos ANT+</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>-->
    <div class="card col-md-12">
    <div class="card-header">Zwift Log Analyzer</div>
        <div class="card-body">
            <input type="file" id='logfile' onchange=openFile(event)>
        </div>
        <div class='card-body'>
            <table id='antDevices' class='table-bordered table-striped table col-md-6 float-left'>
                <thead>
                    <tr>
                        <th>Dispositivos ANT+</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <table id='bleDevices' class='table-bordered table-striped table col-md-6 float-left'>
                <thead>
                    <tr>
                        <th>Dispositivos BLE</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div class='card-body col-md-12' id='graphContainer'>
            
        </div>
    </div>
    
</body>
<script>
    var log, devices, detectedDevices, fpsData;
    var openFile = function (event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function () {
            var text = reader.result;
            log = text
            getFPS().then(function (data) {
                plotFPS(data)
            })
            
            getDevices().then(function () {
                createDevicesTable()
            })

            getUDPStats().then(function (data) {
                plotUDPStats(data)
            })
        };
        reader.readAsText(input.files[0]);
    };

    async function getDevices() {
        var logLines = log.split("\r\n")
        detectedDevices = logLines.filter(line => line.includes("[ANT]") || line.includes("[BLE]"))
        devices = { ant: [], ble: [], used: [] }
        //Buscamos los dispositivos conectados

        detectedDevices.forEach(element => {
            element = element.substring(10).trim()
            if (element.includes(["ANT"]) && !devices.ant.includes(element)) {
                devices.ant.push(element);
            }

            if (element.includes(["BLE"]) && !devices.ble.includes(element)) {
                devices.ble.push(element);
            }
        })
    }

    async function getFPS() {

        var logLines = log.split("\r\n");
        var fpsData = []
        fpsLines = logLines.filter(line => line.includes("FPS"));
        fpsLines.forEach(line => {
            var usefulData = line.split(",")[0]
            var measure_time = usefulData.substring(1, 9);
            var measure_fps = usefulData.split("FPS")[1].trim();
            fpsData.push([measure_time, parseFloat(measure_fps)])
        })

        return fpsData
    }

    async function getUDPStats(){
        var loglines = log.split("\r\n");
        var udpStats = {time:[],StCRx:[], RxError:[], CtSTx:[], TxError:[]}
        udpLines = loglines.filter(line => line.includes("UDP metrics"));
        udpLines.forEach(udpLine => {
            var measure_time = udpLine.substring(1, 9);
            var usefulData = udpLine.split("UDP metrics")[1].trim();
            usefulData = usefulData.replace('StC Rx','"StCRx"')
            usefulData = usefulData.replace('Rx error','"Rxerror"')
            usefulData = usefulData.replace('CtS Tx','"CtSTx"')
            usefulData = usefulData.replace('Tx error','"Txerror"')
            usefulData = JSON.parse(usefulData);
            udpStats.time.push(measure_time)
            udpStats.StCRx.push(usefulData.StCRx)
            udpStats.RxError.push(usefulData.Rxerror)
            udpStats.CtSTx.push(usefulData.CtSTx)
            udpStats.TxError.push(usefulData.Txerror)
            
        })
        return udpStats;
    }
    
    function plotFPS(data) {
        $("#graphContainer").append(`<div id='fpsGraph' class='card-body col-md-12 d-flex justify-content-center'></div>`)
        const fpsTime = data.map(function (item) {
            return item[0];
        });
        const fpsVal = data.map(function (item) {
            return item[1];
        });
        var fpschartDom = document.getElementById("fpsGraph")
        var fpsChart = echarts.init(fpschartDom, 'dark', { height: 250, width: window.innerWidth * 0.9, position: 'absolute' })
        var option;
        option = {
            animation: false,
            title: {
                text: 'FPS'
            },
            tooltip: {
                trigger: 'axis',
                formatter: 'Time: {b0}</br>FPS: {c0}'
            },
            xAxis: {
                type: 'category',
                data: fpsTime
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    data: fpsVal,
                    type: 'line',
                    smooth: true,
                    areaStyle: {}
                }
            ]
        };

        option && fpsChart.setOption(option);

    }

    function createDevicesTable() {
        $("#antDevices tbody, #bleDevices tbody").empty()
        devices.ant.forEach(device => $("#antDevices tbody").append(`<tr><td>${device}</td></tr>`))
        devices.ble.forEach(device => $("#bleDevices tbody").append(`<tr><td>${device}</td></tr>`))
    }

    function plotUDPStats(data) {
        $("#graphContainer").append(`<div id='udpGraph' class='card-body col-md-12 d-flex justify-content-center'></div>`)
        const udpTime = data.time
        const udpStCRx = data.StCRx
        const udpRxError = data.RxError
        const udpCtSTx = data.CtSTx
        const udpTxError = data.TxError
        var udpchartDom = document.getElementById("udpGraph")
        var udpChart = echarts.init(udpchartDom, 'dark', { height: 250, width: window.innerWidth * 0.9, position: 'absolute' })
        var option;
        
        option = {
            animation: false,
            title: {
                text: 'UDP Stats (pkts/minute)'
            },
            legend:{
                data:['StC Rx','Rx Error','CtS Tx','Tx Error']
            },
            tooltip: {
                trigger: 'axis',
                formatter: 'Time: {b0}</br>StC: {c0}</br>Rx Error: {c1}</br>CtS: {c2}</br>Tx Error: {c3}</br>'
            },
            xAxis: {
                type: 'category',
                data: data.time
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name:'StC Rx',
                    data: udpStCRx,
                    type: 'line',
                    smooth: true,
                },
                {
                    name:'Rx Error',
                    data: udpRxError,
                    type: 'line',
                    smooth: true,
                   
                },
                {
                    name:'CtS Tx',
                    data: udpCtSTx,
                    type: 'line',
                    smooth: true,
                },
                {
                    name:'Tx Error',
                    data: udpTxError,
                    type: 'line',
                    smooth: true,
                }
            ]
        };

        option && udpChart.setOption(option);
    }
</script>

</html>